name: Release OpenWrt x86_64 (No Build, Upload Firmware)

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get latest OpenWrt stable release tag
        id: get_latest_tag
        run: |
          TAG=$(curl -s https://api.github.com/repos/openwrt/openwrt/tags \
          | jq -r '.[].name' \
          | grep '^v[0-9]' \
          | grep -vE 'rc|SNAPSHOT' \
          | sort -Vr \
          | head -n1)
          echo "latest_tag=$TAG" >> $GITHUB_OUTPUT

      - name: Clone OpenWrt source (shallow)
        run: git clone --depth=1 --branch "${{ steps.get_latest_tag.outputs.latest_tag }}" https://github.com/openwrt/openwrt.git

      - name: Get version from git tag
        id: getversion
        run: |
          cd openwrt
          VERSION=$(git describe --tags --abbrev=0)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get build time
        id: buildtime
        run: echo "time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release and upload firmware
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.IGH_TOKEN }}
          tag: ${{ steps.getversion.outputs.version }}
          name: OpenWrt x86_64 ${{ steps.getversion.outputs.version }}
          body: |
            ğŸ‰ OpenWrt x86_64 ${{ steps.getversion.outputs.version }}
            ğŸ“… æ„å»ºæ—¶é—´ï¼š${{ steps.buildtime.outputs.time }}
            ğŸ”— ä¸Šæ¸¸æºç ï¼šhttps://github.com/openwrt/openwrt/tree/${{ steps.getversion.outputs.version }}
            ğŸ› ï¸ æ„å»ºæ—¥å¿—ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          artifacts: openwrt/bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined-efi.img.gz
          makeLatest: true
          skipIfReleaseExists: true
