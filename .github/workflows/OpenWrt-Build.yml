name: OpenWrt Build Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      # 这里你需要写你的 OpenWrt 编译步骤，我用一个示例替代
      - name: Simulate build output
        run: |
          mkdir -p openwrt/bin/targets/x86/64
          echo "dummy openwrt image content" > openwrt/bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined-efi.img.gz

      # 19. 提取版本号（这里模拟一个版本号）
      - name: Extract OpenWrt version
        id: getversion
        run: |
          # 模拟版本号输出
          FULLVERSION="24.10.2.0"
          echo "Detected version: $FULLVERSION"
          echo "fullversion=$FULLVERSION" >> $GITHUB_OUTPUT

      # 20. 获取构建时间
      - name: Get build time
        id: buildtime
        run: echo "time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      # 21. 创建 GitHub Release 并上传固件
      - name: Create GitHub Release and upload firmware
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.IGH_TOKEN }}
          tag: openwrt-x86_64-${{ github.run_id }}
          name: OpenWrt x86_64 ${{ steps.getversion.outputs.fullversion }}
          body: |
            🎉 OpenWrt x86_64 ${{ steps.getversion.outputs.fullversion }}
            📅 构建时间：${{ steps.buildtime.outputs.time }}
          files: openwrt/bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined-efi.img.gz

      # 22. 保存版本号到文件
      - name: Save latest built version to file
        run: echo "${{ steps.getversion.outputs.fullversion }}" > last_build_version.txt

      # 23. 缓存版本号文件
      - name: Save last built version cache
        uses: actions/cache@v3
        with:
          path: last_build_version.txt
          key: last-build-version-cache-${{ steps.getversion.outputs.fullversion }}
