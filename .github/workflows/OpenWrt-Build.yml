name: Build OpenWrt x86_64

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä½ çš„ä»“åº“ä»£ç ï¼ˆåŒ…å« config/ å’Œ scripts/ï¼‰
      - uses: actions/checkout@v3

      # 2. å®‰è£… jq
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 3. æ¢å¤ä¸Šæ¬¡æ„å»ºç‰ˆæœ¬ç¼“å­˜
      - name: Restore last built version cache
        id: cache-version
        uses: actions/cache@v3
        with:
          path: last_build_version.txt
          key: last-build-version-cache
          restore-keys: last-build-version-cache

      # 4. è·å–æœ€æ–° OpenWrt stable release tag
      - name: Get latest OpenWrt stable release tag
        id: get_latest_tag
        run: |
          TAG=$(curl -s https://api.github.com/repos/openwrt/openwrt/tags | jq -r '.[].name' | grep '^v[0-9]' | grep -vE 'rc|SNAPSHOT' | sort -Vr | head -n1)
          echo "latest_tag=$TAG" >> $GITHUB_OUTPUT

      # 5. ç‰ˆæœ¬å¯¹æ¯”ï¼Œåˆ¤æ–­æ˜¯å¦è·³è¿‡æ„å»º
      - name: Compare versions
        id: compare
        run: |
          LAST_VER=$(cat last_build_version.txt 2>/dev/null || echo "none")
          echo "Last built version: $LAST_VER"
          echo "Latest upstream version: ${{ steps.get_latest_tag.outputs.latest_tag }}"
          if [ "$LAST_VER" = "${{ steps.get_latest_tag.outputs.latest_tag }}" ]; then
            echo "No new version detected. Skipping build."
            exit 78
          else
            echo "New version detected. Proceeding."
          fi

      # 6. å…‹éš† OpenWrt æºç ï¼ˆæŒ‡å®šæœ€æ–°æ ‡ç­¾ï¼‰
      - name: Clone OpenWrt source
        env:
          LATEST_TAG: ${{ steps.get_latest_tag.outputs.latest_tag }}
        run: |
          git clone --depth=1 --branch "$LATEST_TAG" https://github.com/openwrt/openwrt.git

      # 7. é‡Šæ”¾ç£ç›˜ç©ºé—´
      - name: Free up disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      # 8. æŸ¥çœ‹ç£ç›˜ç©ºé—´
      - name: Show available disk space
        run: df -h

      # 9. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 python3-setuptools python3-distutils-extra \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            rsync unzip zlib1g-dev file wget python3-pyelftools ccache ash

      # 10. æ›´æ–° feeds
      - name: Update all feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 11. åˆ›å»º openwrt/scripts ç›®å½•ï¼Œé¿å…å¤åˆ¶å¤±è´¥
      - name: Prepare openwrt/scripts directory
        run: mkdir -p openwrt/scripts

      # 12. å¤åˆ¶é…ç½®å’Œè„šæœ¬æ–‡ä»¶ï¼Œå¹¶èµ‹æ‰§è¡Œæƒé™
      - name: Copy config and scripts
        run: |
          cp config/.config openwrt/.config
          cp config/customize.sh openwrt/
          cp -r scripts/. openwrt/scripts/
          chmod +x openwrt/customize.sh openwrt/scripts/*.sh

      # 13. æŸ¥çœ‹å¤åˆ¶åçš„è„šæœ¬ç›®å½•å†…å®¹
      - name: List openwrt/scripts contents
        run: ls -l openwrt/scripts

      # 14. è¿è¡Œ ext_packages.sh è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Run ext_packages.sh if present
        run: |
          cd openwrt
          if [ -f scripts/ext_packages.sh ]; then
            chmod +x scripts/ext_packages.sh
            ./scripts/ext_packages.sh
          else
            echo "âŒ ext_packages.sh not found!"
            exit 1
          fi

      # 15. æ¸…ç† customize.sh ä¸­å¤šä½™çš„ cd å‘½ä»¤ï¼Œé¿å…äºŒæ¬¡åˆ‡æ¢ç›®å½•
      - name: Clean customize.sh to remove internal 'cd openwrt'
        run: sed -i '/cd openwrt/d' openwrt/customize.sh

      # 16. è¿è¡Œ customize.sh
      - name: Run customize.sh
        run: |
          cd openwrt
          chmod +x customize.sh
          ./customize.sh

      # 17. ç”Ÿæˆ defconfig å¹¶ä¸‹è½½æºç 
      - name: Make defconfig and download sources
        run: |
          cd openwrt
          make defconfig
          make download -j8

      # 18. ç¼–è¯‘ OpenWrt (x86_64)
      - name: Build OpenWrt (x86_64)
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      # 19. æå– OpenWrt ç‰ˆæœ¬å·ï¼ˆä½¿ç”¨ make -fï¼‰
      - name: Extract OpenWrt version
        id: getversion
        run: |
          cd openwrt
          VERSION=$(make -s -f include/version.mk VAL=VERSION printval)
          PATCHLEVEL=$(make -s -f include/version.mk VAL=PATCHLEVEL printval)
          FULLVERSION="${VERSION}.${PATCHLEVEL}"
          echo "Detected version: $FULLVERSION"
          echo "fullversion=$FULLVERSION" >> $GITHUB_OUTPUT

      # 20. è·å–æ„å»ºæ—¶é—´
      - name: Get build time
        id: buildtime
        run: echo "time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      # 21. åˆ›å»º GitHub Release å¹¶ä¸Šä¼ å›ºä»¶
      - name: Create GitHub Release and upload firmware
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.IGH_TOKEN }}
          tag: openwrt-x86_64-${{ github.run_id }}
          name: OpenWrt x86_64 ${{ steps.getversion.outputs.fullversion }}
          body: |
            ğŸ‰ OpenWrt x86_64 ${{ steps.getversion.outputs.fullversion }}
            ğŸ“… æ„å»ºæ—¶é—´ï¼š${{ steps.buildtime.outputs.time }}
          artifacts: openwrt/bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined-efi.img.gz

      # 22. ä¿å­˜æœ¬æ¬¡æ„å»ºçš„ç‰ˆæœ¬å·åˆ°æ–‡ä»¶
      - name: Save latest built version to file
        run: echo "${{ steps.getversion.outputs.fullversion }}" > last_build_version.txt

      # 23. ç¼“å­˜æœ€æ–°ç‰ˆæœ¬å·æ–‡ä»¶
      - name: Save last built version cache
        uses: actions/cache@v3
        with:
          path: last_build_version.txt
          key: last-build-version-cache-${{ steps.getversion.outputs.fullversion }}
