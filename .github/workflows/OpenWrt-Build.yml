name: Test Latest OpenWrt Clone

on:
  workflow_dispatch:

jobs:
  test-clone:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get latest OpenWrt stable release tag
        id: get_latest_tag
        run: |
          echo "Fetching latest release tag..."
          RESPONSE=$(curl -s https://api.github.com/repos/openwrt/openwrt/releases/latest)
          echo "GitHub API response:"
          echo "$RESPONSE"
          LATEST_TAG=$(echo "$RESPONSE" | jq -r '.tag_name')
          echo "Latest tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Verify latest tag
        run: |
          if [ -z "${{ steps.get_latest_tag.outputs.latest_tag }}" ] || [ "${{ steps.get_latest_tag.outputs.latest_tag }}" = "null" ]; then
            echo "Failed to get latest tag!"
            exit 1
          fi

      - name: Clone OpenWrt source repo with latest tag
        run: |
          git clone --depth=1 --branch ${{ steps.get_latest_tag.outputs.latest_tag }} https://github.com/openwrt/openwrt.git
          ls -l openwrt
