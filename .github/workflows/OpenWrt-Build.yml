name: Test OpenWrt Version and GitHub Release

on:
  workflow_dispatch:

jobs:
  test-release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Clone OpenWrt repo (shallow)
        run: git clone --depth=1 https://github.com/openwrt/openwrt.git

      - name: Extract OpenWrt version
        id: getversion
        run: |
          cd openwrt
          VERSION=$(grep '^VERSION_NUMBER:=' include/version.mk | head -1 | sed 's/.*:= *//')
          if echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+$'; then
            FULLVERSION="v${VERSION}.0"
          else
            FULLVERSION="v${VERSION}"
          fi
          echo "Detected version: $FULLVERSION"
          echo "fullversion=$FULLVERSION" >> $GITHUB_OUTPUT

      - name: Show extracted version
        run: echo "Extracted version is: ${{ steps.getversion.outputs.fullversion }}"

      - name: Create GitHub Release (Draft)
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.IGH_TOKEN }}
          tag: ${{ steps.getversion.outputs.fullversion }}
          name: Test Release ${{ steps.getversion.outputs.fullversion }}
          body: "This is a test draft release for OpenWrt version ${{ steps.getversion.outputs.fullversion }}"
          draft: true
          prerelease: false
