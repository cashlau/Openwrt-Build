name: OpenWrt x86_64 Release (No Build, No Firmware Upload)

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Get latest OpenWrt stable release tag
        id: get_latest_tag
        run: |
          TAG=$(curl -s https://api.github.com/repos/openwrt/openwrt/tags \
            | grep -oP '^  "name": "\Kv[0-9\.]+' \
            | grep -vE 'rc|SNAPSHOT' \
            | sort -Vr \
            | head -n1)
          echo "latest_tag=$TAG" >> $GITHUB_OUTPUT

      - name: Clone OpenWrt source (shallow)
        run: git clone --depth=1 --branch "${{ steps.get_latest_tag.outputs.latest_tag }}" https://github.com/openwrt/openwrt.git

      - name: Get version from git tag
        id: getversion
        run: |
          cd openwrt
          VERSION=$(git describe --tags --abbrev=0)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get current time
        id: buildtime
        run: echo "time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release (No Build)
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.IGH_TOKEN }}
          tag: ${{ steps.getversion.outputs.version }}
          name: OpenWrt x86_64 ${{ steps.getversion.outputs.version }}
          body: |
            ğŸ§ª OpenWrt x86_64 æµ‹è¯•å‘å¸ƒï¼Œæœªç¼–è¯‘å›ºä»¶
            ğŸ”– ç‰ˆæœ¬: ${{ steps.getversion.outputs.version }}
            ğŸ“… æ—¶é—´: ${{ steps.buildtime.outputs.time }}
          draft: false
          prerelease: true
          skipIfReleaseExists: true
