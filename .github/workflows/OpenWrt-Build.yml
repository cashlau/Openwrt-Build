name: OpenWrt Build Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      # æ¨¡æ‹Ÿæ„å»ºè¾“å‡ºæ–‡ä»¶ï¼ˆä½ æ›¿æ¢æˆçœŸå®ç¼–è¯‘æ­¥éª¤ï¼‰
      - name: Simulate build output
        run: |
          mkdir -p openwrt/bin/targets/x86/64
          echo "dummy openwrt image content" > openwrt/bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined-efi.img.gz

      # 19. æå–ç‰ˆæœ¬å·ï¼ˆè¿™é‡Œæ¨¡æ‹Ÿä¸€ä¸ªç‰ˆæœ¬å·ï¼‰
      - name: Extract OpenWrt version
        id: getversion
        run: |
          FULLVERSION="24.10.2.0"
          echo "Detected version: $FULLVERSION"
          echo "fullversion=$FULLVERSION" >> $GITHUB_OUTPUT

      # 20. è·å–æ„å»ºæ—¶é—´
      - name: Get build time
        id: buildtime
        run: echo "time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      # 21. åˆ›å»º GitHub Release å¹¶ä¸Šä¼ å›ºä»¶
      - name: Create GitHub Release and upload firmware
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.IGH_TOKEN }}
          tag: openwrt-x86_64-${{ github.run_id }}
          name: OpenWrt x86_64 ${{ steps.getversion.outputs.fullversion }}
          body: |
            ğŸ‰ OpenWrt x86_64 ${{ steps.getversion.outputs.fullversion }}
            ğŸ“… æ„å»ºæ—¶é—´ï¼š${{ steps.buildtime.outputs.time }}
          artifacts: openwrt/bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined-efi.img.gz

      # 22. ä¿å­˜ç‰ˆæœ¬å·åˆ°æ–‡ä»¶
      - name: Save latest built version to file
        run: echo "${{ steps.getversion.outputs.fullversion }}" > last_build_version.txt

      # 23. ç¼“å­˜ç‰ˆæœ¬å·æ–‡ä»¶
      - name: Save last built version cache
        uses: actions/cache@v3
        with:
          path: last_build_version.txt
          key: last-build-version-cache-${{ steps.getversion.outputs.fullversion }}
