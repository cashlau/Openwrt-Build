name: Build OpenWrt x86_64

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点自动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Clone OpenWrt source
        run: |
          git clone --depth=1 --branch "${{ steps.get_latest_tag.outputs.latest_tag }}" https://github.com/openwrt/openwrt.git

      - name: Clone OpenWrt source
        run: |
          git clone --depth=1 --branch "${{ steps.get_latest_tag.outputs.latest_tag }}" https://github.com/openwrt/openwrt.git

      - name: 🧪 Test extract OpenWrt version from version.mk
        run: |
          cd openwrt
          echo "🧾 内容预览："
          head -n 10 include/version.mk || echo "⚠️ version.mk 文件不存在！"

          VERSION_MAJOR=$(grep '^VERSION_NUMBER:=' include/version.mk | cut -d ':=' -f2 | xargs)
          VERSION_PATCH=$(grep '^VERSION_PATCH:=' include/version.mk | cut -d ':=' -f2 | xargs)

          if [ -z "$VERSION_MAJOR" ]; then
            echo "❌ 未能解析 VERSION_NUMBER"
            exit 1
          fi

          FULLVERSION="v$VERSION_MAJOR"
          [ -n "$VERSION_PATCH" ] && FULLVERSION="$FULLVERSION.$VERSION_PATCH"

          echo "✅ 提取成功：OpenWrt 版本为 $FULLVERSION"
