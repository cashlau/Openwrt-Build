name: Build OpenWrt x86_64

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点自动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug repo content
        run: |
          echo "当前路径：$(pwd)"
          echo "根目录文件列表："
          ls -al
          echo "config 文件夹内容："
          ls -al config || echo "❌ config 文件夹不存在"
          echo "scripts 文件夹内容："
          ls -al scripts || echo "❌ scripts 文件夹不存在"

      - name: Prepare openwrt directory
        run: mkdir -p openwrt/scripts

      - name: Copy config and scripts
        run: |
          cp config/.config openwrt/.config
          cp config/customize.sh openwrt/
          cp -r scripts/. openwrt/scripts/
          chmod +x openwrt/customize.sh openwrt/scripts/*.sh

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Restore last built version cache
        id: cache-version
        uses: actions/cache@v3
        with:
          path: last_build_version.txt
          key: last-build-version-cache
          restore-keys: last-build-version-cache

      - name: Get latest OpenWrt stable release tag
        id: get_latest_tag
        run: |
          TAG=$(curl -s https://api.github.com/repos/openwrt/openwrt/tags | jq -r '.[].name' | grep '^v[0-9]' | grep -vE 'rc|SNAPSHOT' | sort -Vr | head -n1)
          echo "latest_tag=$TAG" >> $GITHUB_OUTPUT
