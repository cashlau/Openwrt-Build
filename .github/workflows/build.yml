name: Build OpenWrt x86_64

on:
  workflow_dispatch:
  #push:
  #  branches:
  #    - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: Enable universe repo and install dependencies
        run: |
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y python3 python3-setuptools python3-distutils-extra \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            rsync unzip zlib1g-dev file wget python3-pyelftools ccache

      - name: Prepare openwrt build directory
        run: |
          rm -rf openwrt
          mkdir -p openwrt

      - name: Clone latest OpenWrt source
        run: |
          git clone https://github.com/openwrt/openwrt.git --depth=1 openwrt

      - name: Copy feeds.conf.default
        run: |
          if [ -f config/feeds.conf.default ]; then
            cp config/feeds.conf.default openwrt/feeds.conf.default
          else
            echo "No feeds.conf.default found in config/, skipping copy"
          fi

      - name: Update & install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Copy config and custom scripts
        run: |
          cp config/.config openwrt/.config
          cp config/customize.sh openwrt/
          cp -r scripts openwrt/scripts
          chmod +x openwrt/customize.sh openwrt/scripts/*.sh

      - name: Run ext_packages.sh if exists
        run: |
          cd openwrt
          if [ -f scripts/ext_packages.sh ]; then
            ./scripts/ext_packages.sh
          else
            echo "No ext_packages.sh found"
          fi

      - name: Run customize.sh
        run: |
          cd openwrt
          ./customize.sh

      - name: Make defconfig and download sources
        run: |
          cd openwrt
          make defconfig
          make download -j8

      - name: Build OpenWrt (x86_64 only)
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-x86_64-firmware
          path: openwrt/bin/targets/x86/64/**/*

      - name: Create GitHub Release and upload firmware
        uses: ncipollo/release-action@v1
        with:
          tag: openwrt-x86_64-${{ github.run_id }}
          name: OpenWrt x86_64 Build ${{ github.run_number }}
          body: |
            üéâ OpenWrt x86_64 Ëá™Âä®ÊûÑÂª∫ÊàêÂäüÔºÅ
            üìÖ ÁºñËØëÊó∂Èó¥Ôºö${{ github.event.workflow_dispatch.timestamp }}
          artifacts: openwrt/bin/targets/x86/64/**/*
